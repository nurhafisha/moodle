{% extends 'base.html.twig' %}

{% block title %}{{ ue.getCodeUE() }} - {{ ue.getNomUE() }}{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('styles/style-contenu-ue.css') }}" />
{% endblock %}

{% block body %}
  <main>
    <h1>{{ ue.getCodeUE() }} {{ ue.getNomUE() }}</h1>
    <ul id="navbar-ue">
      <a href="{{ path('contenu_UE', { 'code_ue': ue.getCodeUE() }) }}" id="selected"><li><span class="material-icons-sharp">school</span><b>Course</b></li></a>
      <a href="{{ path('participants_UE', { 'code_ue': ue.getCodeUE() }) }}"><li><span class="material-icons-sharp">group</span>Participants</li></a>
    </ul>

    {% if is_granted('ROLE_PROF') or is_granted ('ROLE_PROF_ADMIN') %}
    <button id="btn-add-post" onclick="openModalNewPost()">
      <span class="material-icons-sharp">add</span>
      <b>AJOUTER POST</b>
    </button>
    {% endif %}
    
    <ul id="posts">
      {% for post in posts %}
      <li class="post" id="post-{{ post.id }}">
        <div class="post-title">
          <div class="post-title-text">
          
            <span class="material-icons-sharp"
            title="
            {% if post.getTypePost() == 'fichier' %}
                Fichier
            {% elseif post.getTypeMessage() == 'important' %}
                Important
            {% elseif post.getTypeMessage() == 'information' %}
                Information
            {% elseif post.getTypeMessage() == 'optionnel' %}
                Optionnel
            {% endif %}
            " style="cursor: pointer;">
            {% if post.getTypePost() == 'fichier' %}
            description
            {% elseif post.getTypeMessage() == 'important' %}
            priority_high
            {% elseif post.getTypeMessage() == 'information' %}
            mail
            {% elseif post.getTypeMessage() == 'optionnel' %}
            recommend
            {% endif %}
            </span>

            {% if post.getTypePost() == 'fichier' %}
              {% if post.getDepotPostBlob() and post.getDepotPostName() ends with '.pdf' %}
              <a href="{{ path('pdf_view', {'code_ue': ue.getCodeUE(), 'idPost': post.getId()}) }}" 
                target="_blank"
                rel="noopener noreferrer">
              {% else %}
                <a href="{{ path('post_download', {'code_ue': ue.getCodeUE(), 'idPost': post.getId()}) }}">
              {% endif %}
            {% endif %}
            

            <span><h3>{{ post.getTitrePost() }}</h3></span>

            {% if post.getTypePost() == 'fichier' %}</a>{% endif %}

            {% if is_granted('ROLE_PROF') or is_granted ('ROLE_PROF_ADMIN')%}
            <a href="{{ path('post_edit', { 'post': post, 'idPost': post.getId(), 'code_ue': ue.getCodeUE() }) }}"><span class="material-icons-sharp btn-edit-post">edit_note</span></a>
            <button class="delete-button" data-id="{{ post.id }}" data-code="{{ ue.getCodeUE() }}" data-token="{{ csrf_token('delete-post') }}">
              <span class="material-icons-sharp" id="delete-button">delete</span>
            </button>
            {% endif %}
            
          </div>
          <div class="post-time">
            <p>{{ post.getDatetimePost()|date('d/m/Y H:i') }}</p>
          </div>
        </div>
        <p class="description">{{ post.getDescriptionPost()|nl2br|raw }}</p>
        <button class="read-more-btn">Lire plus</button>
      </li>
      {% else %}
        <li class="post">Aucun post pour cette UE.</li>
      {% endfor %}

    </ul>

    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <p>Voulez-vous vraiment supprimer ce post?</p>
            <div class="modal-buttons">
                <button class="confirm-btn" onclick="confirmDelete()">Oui</button>
                <button class="cancel-btn" onclick="closeModal()">Annuler</button>
            </div>
        </div>
    </div>
  </main>

  <div class="modal" id="post-modal">
    <div id="post-modal-content">
      <h2 id="titre-new-post"><b>Créer Nouveau Post</b></h2>
      <form action="{{ path('new_post', {'code_ue': ue.getCodeUE()}) }}" name="post" method="POST" id="div-form" enctype="multipart/form-data">
        <div class="post-tabs">
            <!-- Un seul bouton pour basculer entre les options -->
            <button type="button" id="tab-msgtxt" class="tablinks active" onclick="toggleFormView('msgtxt')">Message Texte</button>
            <button type="button" id="tab-partagefic" class="tablinks" onclick="toggleFormView('partagefic')">Partage Fichier</button>
        </div>

        <div class="form-container">
            <div class="form-group">
                <label for="post_titrePost" class="required">Titre</label>
                <input type="text" id="post_titrePost" name="post[titrePost]" required="required" maxlength="255">
            </div>

            <input type="hidden" id="post_typePost" name="post[typePost]" value="message">

            <input
                type="hidden"
                id="post_datetimePost"
                name="post[datetimePost]"
                required="required"
                value="{{ 'now'|date('Y-m-d\\TH:i:s') }}"
            >

            <div class="form-group" id="post_typeMessage">
                <label for="post_typeMessageSelect" class="required">Type</label>
                <select id="post_typeMessageSelect" name="post[typeMessage]" required>
                    <option value="" selected disabled>-- Choisir un type --</option>
                    <option value="important">Important</option>
                    <option value="information">Information</option>
                    <option value="optionnel">Optionnel</option>
                </select>
            </div>

            <div class="form-group">
                <label for="post_descriptionPost" class="required">Texte</label>
                <textarea oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"
                id="post_descriptionPost" name="post[descriptionPost]" required="required" maxlength="2000"></textarea>
            </div>

            <div class="form-group" id="post_depotPost" style="display: none;">
                <label for="post_depotPostInput">Fichier (formats acceptés : .zip, .pdf)</label>
                <input type="file" id="post_depotPostInput" name="post[depotPostBlob]" accept=".zip,.pdf">
            </div>

            <input type="hidden" id="post_codeUE" name="post[codeUE]" value="{{ ue.getCodeUE() }}">
            <input type="hidden" id="post__token" name="post[_token]" data-controller="csrf-protection" value="csrf-token">

            <div class="form-actions">
                <button class="btn" type="submit">Créer</button>
            </div>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block script %}
    <script src="{{ asset('contenu-ue.js') }}"></script>
{% endblock %}